<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
 
   <PropertyGroup>
      <MSBuildCommunityTasksPath Condition=" '$(MSBuildCommunityTasksPath)' == '' ">$(SolutionDir)\packages\MSBuildTasks.1.4.0.88\tools</MSBuildCommunityTasksPath>
      
      <VersionFile Condition=" '$(VersionFile)' == '' ">$(MsBuildProjectDirectory)\Properties\Version.txt</VersionFile>
      <VersionSuffixFile Condition=" '$(VersionSuffixFile)' == '' ">$(MsBuildProjectDirectory)\Properties\VersionSuffix.txt</VersionSuffixFile>
      <AssemblyCopyright Condition="'$(AssemblyCopyright)' == ''"></AssemblyCopyright>
 
      <SetAssemblyVersionEnabled Condition=" Exists('$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.targets') AND Exists($(VersionFile)) ">true</SetAssemblyVersionEnabled>
      <SetAssemblyVersionEnabled Condition=" '$(SetAssemblyVersionEnabled)' == '' ">false</SetAssemblyVersionEnabled>
 
      <BuildDependsOn Condition=" '$(SetAssemblyVersionEnabled)' == 'true' ">
         SetAssemblyVersion;
         $(BuildDependsOn)
      </BuildDependsOn>
 
   </PropertyGroup>
 
   <Import Condition=" '$(SetAssemblyVersionEnabled)' == 'true' "
      Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.targets"
   />
 
   <!-- Workaround for missing task declaration in MSbuildTasks project (pull request already sent) -->
   <UsingTask Condition="Exists($(MSBuildCommunityTasksLib))"
      AssemblyFile="$(MSBuildCommunityTasksLib)"
      TaskName="MSBuild.Community.Tasks.Git.GitBranch"
   />
 
   <Target Name="SetAssemblyVersion">
      <Exec Command="git rev-parse --short --verify  HEAD" ConsoleToMSBuild="true">
         <Output TaskParameter="ConsoleOutput" PropertyName="CommitHash" />
      </Exec>


      <PropertyGroup>
         <Version>$([System.IO.File]::ReadAllText($(VersionFile)))</Version>
         <VersionSuffix Condition="Exists('$(VersionSuffixFile)')">$([System.IO.File]::ReadAllText($(VersionSuffixFile)))</VersionSuffix>
         <VersionSuffix Condition=" '$(VersionSuffix)' == '' "></VersionSuffix>
         <BuildDate>$([System.DateTime]::UtcNow.ToString("yyyyMMdd"))</BuildDate>
         <AssemblyCopyrightText Condition=" '$(AssemblyCopyright)' != '' ">$(AssemblyCopyright) $([System.DateTime]::UtcNow.Year)</AssemblyCopyrightText>
         <AssemblyCopyrightText Condition=" '$(AssemblyCopyrightText)' == '' "></AssemblyCopyrightText>
         <BuildVersion>$(Version)-v$(BuildDate)-$(CommitHash)</BuildVersion>

      </PropertyGroup>

      <!--
      weird error on my pc :()
      <GitVersion LocalPath="$(SolutionDir)">
         <Output TaskParameter="CommitHash" PropertyName="CommitHash" />
      </GitVersion>
   -->
      
 
      
     <FileUpdate Files="$(MsBuildProjectDirectory)\Properties\AssemblyInfo.cs"
            Regex="AssemblyVersion\(&quot;.*&quot;\)\]"
            ReplacementText="AssemblyVersion(&quot;$(Version)&quot;)]" />

      <FileUpdate Files="$(MsBuildProjectDirectory)\Properties\AssemblyInfo.cs"
            Regex="AssemblyInformationalVersion\(&quot;.*&quot;\)\]"
            ReplacementText="AssemblyInformationalVersion(&quot;$(BuildVersion)&quot;)]" />

      <!-- cannot understand why nuget does not take the proper version otherwise -->
      
      <FileUpdate Files="$(MsBuildProjectDirectory)\$(AssemblyName).nuspec"
            Regex="&lt;version&gt;.*&lt;/version&gt;"
            ReplacementText="&lt;version&gt;$(BuildVersion)&lt;/version&gt;" />
      



   </Target>
 
 
</Project>